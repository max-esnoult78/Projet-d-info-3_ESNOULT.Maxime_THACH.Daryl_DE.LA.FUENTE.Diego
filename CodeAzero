#!/bin/bash

# Vérification des paramètres
if [ "$1" == "-h" ] || [ "$#" -lt 3 ]; then
    echo "Usage: $0 <chemin_fichier_csv> <type_station> <type_consommateur> [id_centrale]"
    echo "  <type_station> : hvb | hva | lv"
    echo "  <type_consommateur> : comp | indiv | all"
    echo "  [id_centrale] : optionnel, identifiant de la centrale"
    echo "Option d'aide : -h"
    exit 0
fi

# Récupération des paramètres
FICHIER_CSV="$1"
TYPE_STATION="$2"
TYPE_CONSOMMATEUR="$3"
ID_CENTRALE="$4"

# Vérification des types de station et consommateur
if [[ "$TYPE_STATION" != "hvb" && "$TYPE_STATION" != "hva" && "$TYPE_STATION" != "lv" ]]; then
    echo "Erreur : Type de station invalide. Choisir parmi 'hvb', 'hva' ou 'lv'."
    exit 1
fi

if [[ "$TYPE_STATION" == "hvb" && "$TYPE_CONSOMMATEUR" != "comp" ]] || \
   [[ "$TYPE_STATION" == "hva" && "$TYPE_CONSOMMATEUR" != "comp" ]]; then
    echo "Erreur : Pour 'hvb' et 'hva', seuls 'comp' est autorisé."
    exit 1
fi

# Création des répertoires requis
mkdir -p tmp graphs tests

# Vérification de la présence du programme C et compilation
cd codeC
if [ ! -f "c-wire" ]; then
    echo "Compilation du programme C..."
    make
    if [ $? -ne 0 ]; then
        echo "Erreur : Échec de la compilation."
        exit 1
    fi
fi
cd ..

# Filtrage des données
echo "Filtrage des données..."
FILTRE_OUTPUT="tmp/filtre_${TYPE_STATION}_${TYPE_CONSOMMATEUR}.csv"

if [ -n "$ID_CENTRALE" ]; then
    awk -F';' -v ts="$TYPE_STATION" -v tc="$TYPE_CONSOMMATEUR" -v idc="$ID_CENTRALE" '
    ($1 == idc) && 
    ((ts == "hvb" && $2 != "-") || 
     (ts == "hva" && $3 != "-") || 
     (ts == "lv" && $4 != "-")) {print $0}
    ' "$FICHIER_CSV" > "$FILTRE_OUTPUT"
else
    awk -F';' -v ts="$TYPE_STATION" -v tc="$TYPE_CONSOMMATEUR" '
    (ts == "hvb" && $2 != "-") || 
    (ts == "hva" && $3 != "-") || 
    (ts == "lv" && $4 != "-") {print $0}
    ' "$FICHIER_CSV" > "$FILTRE_OUTPUT"
fi

# Exécution du programme C
echo "Exécution du programme C pour traitement..."
codeC/c-wire "$FILTRE_OUTPUT" "tests/result_${TYPE_STATION}_${TYPE_CONSOMMATEUR}.csv"
if [ $? -ne 0 ]; then
    echo "Erreur : Le programme C a rencontré un problème."
    exit 1
fi

# Finalisation
echo "Traitement terminé. Résultats sauvegardés dans 'tests/'."
